<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload File - Vaultify</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="dashboard-layout">
  <header class="main-header">
    <nav class="navbar">
      <div class="navbar-brand">
        <a href="/dashboard.html">Vaultify</a>
      </div>
      <div class="navbar-center">
        <ul class="navbar-menu">
          <li><a href="dashboard.html">Dashboard</a></li>
          <li><a href="#" class="nav-active">Upload</a></li>
        </ul>
      </div>
      <div class="navbar-right">
        <a href="#" onclick="logout()" class="btn btn-secondary btn-small">Logout</a>
      </div>
      <button class="navbar-toggle" aria-label="Toggle Navigation">
        <span class="toggle-icon"></span>
        <span class="toggle-icon"></span>
        <span class="toggle-icon"></span>
      </button>
    </nav>
  </header>
  <main class="container upload-page">
    <h2>Upload a File</h2>
    <form id="uploadForm" enctype="multipart/form-data">
      <input type="file" name="file" required />
      
      <!-- QR Code Sharing Options -->
      <div class="upload-options" style="margin: 1rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
        <h3>üîó Sharing Options</h3>
        <label>
          <input type="checkbox" id="generateQR" name="generateQR" />
          Generate QR Code for instant sharing
        </label>
        
        <div id="qrOptions" style="display: none; margin-top: 1rem; padding-left: 1.5rem;">
          <div style="margin: 0.5rem 0;">
            <label>
              <input type="checkbox" id="isPublic" name="isPublic" />
              Make publicly accessible (no login required)
            </label>
          </div>
          
          <div style="margin: 0.5rem 0;">
            <label for="maxAccess">Access Limit:</label>
            <select id="maxAccess" name="maxAccess" style="margin-left: 0.5rem;">
              <option value="">Unlimited</option>
              <option value="1">1 access</option>
              <option value="5">5 accesses</option>
              <option value="10">10 accesses</option>
              <option value="25">25 accesses</option>
              <option value="50">50 accesses</option>
            </select>
          </div>
          
          <div style="margin: 0.5rem 0;">
            <label for="expiresIn">Expires in:</label>
            <select id="expiresIn" name="expiresIn" style="margin-left: 0.5rem;">
              <option value="">Never</option>
              <option value="1">1 day</option>
              <option value="3">3 days</option>
              <option value="7">1 week</option>
              <option value="30">1 month</option>
            </select>
          </div>
          
          <div style="margin: 0.5rem 0;">
            <label>
              <input type="checkbox" id="canDownload" name="canDownload" checked />
              Allow downloads
            </label>
          </div>
        </div>
      </div>
      
      <button type="submit">Upload & Encrypt</button>
    </form>

    <div id="responseMsg"></div>
    
    <!-- QR Code Display Area -->
    <div id="qrCodeResult" style="display: none; margin: 2rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; text-align: center;">
      <h3>üì± QR Code Generated!</h3>
      <div id="qrCodeDisplay"></div>
      <div id="shareUrlDisplay" style="margin: 1rem 0;"></div>
      <div style="margin: 1rem 0;">
        <button onclick="copyQRShareUrl()" class="btn btn-secondary">üìã Copy Share URL</button>
        <button onclick="downloadQRCodeImage()" class="btn btn-secondary">üíæ Download QR Code</button>
        <button onclick="viewQRDetails()" class="btn btn-primary">üëÅÔ∏è View QR Details</button>
      </div>
    </div>

    <button onclick="location.href='/dashboard.html'" style="margin-top: 15px;">‚Üê Back to Dashboard</button>
  </main>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <div id="loadingMessage">Uploading and encrypting...</div>
    </div>
  </div>

  <script>
    let currentQRData = null;
    let currentShareId = null;

    // Mobile navbar toggle
    const toggleButton = document.querySelector('.navbar-toggle');
    const navbarMenu = document.querySelector('.navbar-menu');

    if (toggleButton && navbarMenu) {
      toggleButton.addEventListener('click', () => {
        navbarMenu.classList.toggle('active');
      });

      // Close mobile menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!toggleButton.contains(e.target) && !navbarMenu.contains(e.target)) {
          navbarMenu.classList.remove('active');
        }
      });
    }

    // Toggle QR options visibility
    document.getElementById('generateQR').addEventListener('change', function() {
      const qrOptions = document.getElementById('qrOptions');
      qrOptions.style.display = this.checked ? 'block' : 'none';
    });

    function logout() {
      sessionStorage.removeItem("token");
      window.location.href = "/login.html";
    }

    function showLoader(message) {
      const overlay = document.getElementById('loadingOverlay');
      const loadingMessage = document.getElementById('loadingMessage');
      loadingMessage.textContent = message || 'Loading...';
      overlay.style.display = 'flex';
    }

    function hideLoader() {
      const overlay = document.getElementById('loadingOverlay');
      overlay.style.display = 'none';
    }

    function copyQRShareUrl() {
      if (currentQRData && currentQRData.qrShareUrl) {
        navigator.clipboard.writeText(currentQRData.qrShareUrl).then(() => {
          showMessage('QR share URL copied to clipboard!', 'success');
        }).catch(err => {
          showMessage('Failed to copy URL', 'error');
        });
      }
    }

    function downloadQRCodeImage() {
      if (currentQRData && currentQRData.qrCode) {
        const link = document.createElement('a');
        link.download = 'vaultify-qr-share.png';
        link.href = currentQRData.qrCode;
        link.click();
      }
    }

    function viewQRDetails() {
      if (currentShareId) {
        window.open(`qr-share.html?shareId=${currentShareId}`, '_blank');
      }
    }

    function showMessage(message, type) {
      const existingMsg = document.querySelector('.temp-message');
      if (existingMsg) existingMsg.remove();

      const messageDiv = document.createElement('div');
      messageDiv.className = `alert alert-${type} temp-message`;
      messageDiv.textContent = message;
      messageDiv.style.margin = '1rem 0';
      messageDiv.style.padding = '1rem';
      messageDiv.style.borderRadius = '4px';
      messageDiv.style.backgroundColor = type === 'success' ? '#d4edda' : '#f8d7da';
      messageDiv.style.color = type === 'success' ? '#155724' : '#721c24';
      messageDiv.style.border = type === 'success' ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
      
      const responseMsg = document.getElementById('responseMsg');
      responseMsg.insertBefore(messageDiv, responseMsg.firstChild);
      
      setTimeout(() => messageDiv.remove(), 5000);
    }

    document.addEventListener("DOMContentLoaded", () => {
      const token = sessionStorage.getItem("token");
      if (!token) {
        alert("Unauthorized access. Please log in first.");
        window.location.href = "/login.html";
        return;
      }

      document.getElementById("uploadForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);

        try {
          showLoader('Uploading and encrypting...');
          
          const res = await fetch("/api/files/upload", {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
            body: formData
          });

          const result = await res.json();

          if (res.ok) {
            // Check if QR code should be generated
            const generateQR = document.getElementById('generateQR').checked;
            
            if (generateQR) {
              await generateQRForUploadedFile(result.file.id, token);
            } else {
              hideLoader();
              document.getElementById("responseMsg").innerHTML = 
                `<p style="color: green;">Success! File uploaded and encrypted. <a href="${result.downloadLink}" target="_blank">Download Link</a></p>`;
            }
          } else {
            hideLoader();
            document.getElementById("responseMsg").innerHTML = 
              `<p style="color: red;">Error: ${result.message}</p>`;
          }
        } catch (err) {
          hideLoader();
          document.getElementById("responseMsg").innerHTML = 
            `<p style="color: red;">Upload failed. Try again.</p>`;
        }
      });
    });

    async function generateQRForUploadedFile(fileId, token) {
      try {
        showLoader('Generating QR code...');
        
        // Debug: Log the fileId to make sure it's being passed correctly
        console.log('Generating QR for fileId:', fileId);
        
        // Collect QR options
        const qrOptions = {
          fileId: fileId,
          isPublic: document.getElementById('isPublic').checked,
          maxAccess: document.getElementById('maxAccess').value || null,
          expiresIn: document.getElementById('expiresIn').value || null,
          permissions: {
            canDownload: document.getElementById('canDownload').checked,
            canView: true
          }
        };

        const response = await fetch('/api/share/generate-qr', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(qrOptions)
        });

        const qrResult = await response.json();
        
        hideLoader();

        if (response.ok) {
          currentQRData = qrResult;
          currentShareId = qrResult.shareId;
          
          // Display success message
          document.getElementById("responseMsg").innerHTML = 
            `<p style="color: green;">‚úÖ File uploaded and QR code generated successfully!</p>`;

          // Display QR code
          displayQRCode(qrResult);
        } else {
          document.getElementById("responseMsg").innerHTML = 
            `<p style="color: orange;">‚ö†Ô∏è File uploaded successfully, but QR generation failed: ${qrResult.message}</p>`;
        }
      } catch (error) {
        hideLoader();
        console.error('QR generation error:', error);
        document.getElementById("responseMsg").innerHTML = 
          `<p style="color: orange;">‚ö†Ô∏è File uploaded successfully, but QR generation failed. You can generate it later from your dashboard.</p>`;
      }
    }

    function displayQRCode(qrData) {
      const qrResult = document.getElementById('qrCodeResult');
      const qrDisplay = document.getElementById('qrCodeDisplay');
      const shareUrlDisplay = document.getElementById('shareUrlDisplay');

      qrDisplay.innerHTML = `<img src="${qrData.qrCode}" alt="QR Code" style="max-width: 256px; border: 2px solid #ddd; border-radius: 8px;">`;
      shareUrlDisplay.innerHTML = `
        <p><strong>Share URL:</strong></p>
        <div style="background: #f5f5f5; padding: 0.5rem; border-radius: 4px; word-break: break-all; font-family: monospace;">
          ${qrData.qrShareUrl || qrData.shareUrl}
        </div>
      `;

      qrResult.style.display = 'block';
    }
  </script>
</body>
</html>