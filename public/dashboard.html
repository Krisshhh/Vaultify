<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Vaultify</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="dashboard-layout">
  <header class="main-header">
    <nav class="navbar">
      <div class="navbar-brand">
        <a href="/dashboard.html">Vaultify</a>
      </div>
      <div class="navbar-center">
        <ul class="navbar-menu">
          <li><a href="#" onclick="showTab('overview')" class="nav-active">Overview</a></li>
          <li><a href="#" onclick="showTab('myFiles')">My Files</a></li>
          <li><a href="#" onclick="showTab('shared')">Shared</a></li>
          <li><a href="#" onclick="showTab('myShares')">My Shares</a></li>
        </ul>
      </div>
      <div class="navbar-right">
        <a href="upload.html" class="btn btn-primary btn-small">Upload</a>
        <a href="#" onclick="logout()" class="btn btn-secondary btn-small">Logout</a>
      </div>
      <button class="navbar-toggle" aria-label="Toggle Navigation">
        <span class="toggle-icon"></span>
        <span class="toggle-icon"></span>
        <span class="toggle-icon"></span>
      </button>
    </nav>
  </header>
  <main class="container user-dashboard">
    <h2>User Dashboard</h2>
    
    <div class="tab-buttons">
      <button class="tab-button active" onclick="showTab('overview')">Overview</button>
      <button class="tab-button" onclick="showTab('myFiles')">My Files</button>
      <button class="tab-button" onclick="showTab('shared')">Shared with Me</button>
      <button class="tab-button" onclick="showTab('myShares')">My Shares</button>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
      <div id="dashboardData">
        <!-- User data will be dynamically loaded -->
      </div>
      <button onclick="location.href='/upload.html'">Upload New File</button>
    </div>

    <!-- My Files Tab -->
    <div id="myFiles" class="tab-content">
      <h3>My Files</h3>
      <div id="myFilesContainer">
        <!-- Files will be loaded here -->
      </div>
    </div>

    <!-- Shared Files Tab -->
    <div id="shared" class="tab-content">
      <h3>Files Shared with Me</h3>
      <div id="sharedFilesContainer">
        <!-- Shared files will be loaded here -->
      </div>
    </div>

    <!-- My Shares Tab -->
    <div id="myShares" class="tab-content">
      <h3>Files I've Shared</h3>
      <div id="mySharesContainer">
        <!-- My shares will be loaded here -->
      </div>
    </div>

    <button onclick="logout()" style="margin-top: 20px;">Logout</button>

    <!-- File Share Modal -->
    <div id="shareModal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="close" onclick="closeShareModal()">&times;</span>
        <h3>Share File</h3>
        <form id="shareForm">
          <input type="hidden" id="shareFileId" />
          <input type="email" id="shareEmail" placeholder="Email to share with" required />
          <label>
            <input type="checkbox" id="canDownload" checked /> Allow Download
          </label>
          <label>
            <input type="checkbox" id="canView" checked /> Allow View
          </label>
          <label>
            Expires in (days): <input type="number" id="expiresIn" min="1" max="365" />
          </label>
          <button type="submit">Share File</button>
        </form>
      </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <div id="loadingMessage">Loading...</div>
      </div>
    </div>
  </main>

  <script>
    // Mobile navbar toggle
    const toggleButton = document.querySelector('.navbar-toggle');
    const navbarMenu = document.querySelector('.navbar-menu');

    if (toggleButton && navbarMenu) {
      toggleButton.addEventListener('click', () => {
        navbarMenu.classList.toggle('active');
      });

      // Close mobile menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!toggleButton.contains(e.target) && !navbarMenu.contains(e.target)) {
          navbarMenu.classList.remove('active');
        }
      });

      // Update active nav link based on current tab
      function updateNavActiveState(tabName) {
        document.querySelectorAll('.navbar-menu a').forEach(link => {
          link.classList.remove('nav-active');
        });
        
        const activeLink = document.querySelector(`.navbar-menu a[onclick="showTab('${tabName}')"]`);
        if (activeLink) {
          activeLink.classList.add('nav-active');
        }
      }
    }
    const token = sessionStorage.getItem("token");
    if (!token) {
      alert("Unauthorized access. Please login first.");
      window.location.href = "/login.html";
    }

    let currentTab = 'overview';

    // Tab switching functionality
    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(tabName).classList.add('active');
      document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
      
      currentTab = tabName;
      
      // Load data for the tab
      switch(tabName) {
        case 'overview':
          fetchDashboardData();
          break;
        case 'myFiles':
          loadMyFiles();
          break;
        case 'shared':
          loadSharedFiles();
          break;
        case 'myShares':
          loadMyShares();
          break;
      }
    }

    // Make authenticated requests
    async function makeAuthRequest(url, options = {}) {
      const response = await fetch(url, {
        ...options,
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
          ...options.headers
        }
      });

      if (response.status === 401) {
        alert('Session expired. Please login again.');
        sessionStorage.removeItem('token');
        window.location.href = '/login.html';
        return null;
      }

      return response;
    }

    // Load dashboard overview
    async function fetchDashboardData() {
      try {
        const res = await makeAuthRequest("/api/files/dashboard");
        if (!res) return;

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.message);
        }

        const fileListHTML = data.recentFiles.length > 0
          ? data.recentFiles.map(file => `
              <li>
                <strong>${file.originalName}</strong> (${(file.size || 0).toFixed(2)} KB)
              </li>
            `).join('')
          : "<li>No recent files</li>";

        document.getElementById("dashboardData").innerHTML = `
          <p><strong>Total Files Uploaded:</strong> ${data.totalFiles}</p>
          <p><strong>Total Storage Used:</strong> ${data.storageUsed.toFixed(2)} KB</p>
          <p><strong>Recent Uploads:</strong></p>
          <ul>${fileListHTML}</ul>
        `;
      } catch (err) {
        alert("Failed to load dashboard: " + err.message);
        document.getElementById("dashboardData").innerHTML = "<p>Error loading data.</p>";
      }
    }

    // Load user's files
    async function loadMyFiles() {
      try {
        const res = await makeAuthRequest('/api/files/my-files');
        if (!res) return;

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.message);
        }

        const filesHTML = data.files.length > 0
          ? data.files.map(file => `
              <div class="file-item">
                <div class="file-info">
                  <div class="file-name">${file.originalName}</div>
                  <div class="file-meta">
                    ${(file.size / 1024).toFixed(2)} KB â€¢ ${file.mimetype} â€¢ 
                    Uploaded: ${new Date(file.uploadDate).toLocaleDateString()}
                  </div>
                </div>
                <div class="file-actions">
                  <button class="btn btn-small" onclick="downloadFile('${file.downloadToken}')">
                    Download
                  </button>
                  <button class="btn btn-small" onclick="shareFile('${file._id}')">
                    Share
                  </button>
                  <button class="btn btn-small" onclick="generateQRCode('${file._id}')" style="background: #7c3aed;">
                    ðŸ“± QR Share
                  </button>
                  <button class="btn btn-small" onclick="deleteFile('${file._id}')" style="background: #dc2626;">
                    Delete
                  </button>
                </div>
              </div>
            `).join('')
          : '<p>No files uploaded yet.</p>';

        document.getElementById('myFilesContainer').innerHTML = filesHTML;
      } catch (err) {
        document.getElementById('myFilesContainer').innerHTML = '<p>Error loading files.</p>';
      }
    }

    // Load shared files
    async function loadSharedFiles() {
      try {
        const res = await makeAuthRequest('/api/share/received');
        if (!res) return;

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.message);
        }

        const sharedHTML = data.sharedFiles.length > 0
          ? data.sharedFiles.map(share => `
              <div class="file-item">
                <div class="file-info">
                  <div class="file-name">${share.fileId.originalName}</div>
                  <div class="file-meta">
                    ${(share.fileId.size / 1024).toFixed(2)} KB â€¢ ${share.fileId.mimetype} â€¢
                    Shared by: ${share.sharedBy.username} (${share.sharedBy.email})
                  </div>
                </div>
                <div class="file-actions">
                  ${share.permissions.canDownload ? 
                    `<button class="btn btn-small" onclick="downloadSharedFile('${share.shareToken}')">
                      Download
                    </button>` : ''}
                  <button class="btn btn-small" onclick="viewSharedFile('${share.shareToken}')">
                    View Details
                  </button>
                </div>
              </div>
            `).join('')
          : '<p>No files shared with you.</p>';

        document.getElementById('sharedFilesContainer').innerHTML = sharedHTML;
      } catch (err) {
        document.getElementById('sharedFilesContainer').innerHTML = '<p>Error loading shared files.</p>';
      }
    }

    // Load user's shares
    async function loadMyShares() {
      try {
        const res = await makeAuthRequest('/api/share/sent');
        if (!res) return;

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.message);
        }

        const sharesHTML = data.mySharedFiles.length > 0
          ? data.mySharedFiles.map(share => {
              const hasQR = share.qrInfo && share.qrInfo.hasQR;
              const shareTypeIcon = hasQR ? 'ðŸ“±' : 'ðŸ‘¤';
              const shareTypeText = share.shareType === 'qr' ? 'QR Only' : 
                                   share.shareType === 'both' ? 'User + QR' : 'User Only';
              
              return `
              <div class="file-item">
                <div class="file-info">
                  <div class="file-name">${shareTypeIcon} ${share.fileId.originalName}</div>
                  <div class="file-meta">
                    ${share.sharedWith ? `Shared with: ${share.sharedWith.username} (${share.sharedWith.email}) â€¢ ` : ''}
                    Type: ${shareTypeText} â€¢ 
                    Downloads: ${share.downloadCount} â€¢ 
                    ${hasQR ? `QR Access: ${share.qrInfo.accessCount}/${share.qrInfo.maxAccess} â€¢ ` : ''}
                    Created: ${new Date(share.createdAt).toLocaleDateString()}
                  </div>
                </div>
                <div class="file-actions">
                  <button class="btn btn-small" onclick="copyShareLink('${share.shareToken}')">
                    Copy Link
                  </button>
                  ${hasQR ? `
                    <button class="btn btn-small" onclick="viewQRCode('${share._id}')" style="background: #7c3aed;">
                      View QR
                    </button>
                  ` : ''}
                  <button class="btn btn-small" onclick="revokeShare('${share._id}')" style="background: #dc2626;">
                    Revoke
                  </button>
                </div>
              </div>
            `;
          }).join('')
          : '<p>You haven\'t shared any files yet.</p>';

        document.getElementById('mySharesContainer').innerHTML = sharesHTML;
      } catch (err) {
        document.getElementById('mySharesContainer').innerHTML = '<p>Error loading shares.</p>';
      }
    }

    // File action functions
    async function downloadFile(token) {
      try {
        showLoader('Preparing download...');
        
        const response = await fetch(`/api/files/download/${token}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${sessionStorage.getItem('token')}`
          }
        });
        
        hideLoader();
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Download failed');
        }
        
        // Get filename from response headers or use default
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = 'download';
        if (contentDisposition) {
          const filenameMatch = contentDisposition.match(/filename="(.+)"/);
          if (filenameMatch) {
            filename = filenameMatch[1];
          }
        }
        
        // Create blob and download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
      } catch (error) {
        hideLoader();
        alert('Download failed: ' + error.message);
      }
    }

    async function downloadSharedFile(token) {
      try {
        showLoader('Preparing download...');
        
        const response = await fetch(`/api/share/download/${token}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${sessionStorage.getItem('token')}`
          }
        });
        
        hideLoader();
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Download failed');
        }
        
        // Get filename from response headers or use default
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = 'download';
        if (contentDisposition) {
          const filenameMatch = contentDisposition.match(/filename="(.+)"/);
          if (filenameMatch) {
            filename = filenameMatch[1];
          }
        }
        
        // Create blob and download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
      } catch (error) {
        hideLoader();
        alert('Download failed: ' + error.message);
      }
    }

    async function viewSharedFile(token) {
      try {
        const res = await makeAuthRequest(`/api/share/view/${token}`);
        if (!res) return;

        const data = await res.json();
        if (res.ok) {
          alert(`File Details:\nName: ${data.file.filename}\nSize: ${(data.file.size / 1024).toFixed(2)} KB\nType: ${data.file.mimetype}\nShared by: ${data.sharedBy.username}`);
        } else {
          throw new Error(data.message);
        }
      } catch (err) {
        alert('Failed to load file details: ' + err.message);
      }
    }

    async function deleteFile(fileId) {
      if (!confirm('Are you sure you want to delete this file?')) return;

      try {
        const res = await makeAuthRequest(`/api/files/delete/${fileId}`, {
          method: 'DELETE'
        });
        
        if (res && res.ok) {
          alert('File deleted successfully');
          loadMyFiles(); // Reload the files list
        } else {
          const data = await res.json();
          throw new Error(data.message);
        }
      } catch (err) {
        alert('Failed to delete file: ' + err.message);
      }
    }

    function shareFile(fileId) {
      document.getElementById('shareFileId').value = fileId;
      document.getElementById('shareModal').style.display = 'block';
    }

    function closeShareModal() {
      document.getElementById('shareModal').style.display = 'none';
      document.getElementById('shareForm').reset();
    }

    async function revokeShare(shareId) {
      if (!confirm('Are you sure you want to revoke this share?')) return;

      try {
        const res = await makeAuthRequest(`/api/share/revoke/${shareId}`, {
          method: 'DELETE'
        });
        
        if (res && res.ok) {
          alert('Share revoked successfully');
          loadMyShares(); // Reload the shares list
        } else {
          const data = await res.json();
          throw new Error(data.message);
        }
      } catch (err) {
        alert('Failed to revoke share: ' + err.message);
      }
    }

    function copyShareLink(token) {
      const link = `${window.location.origin}/api/share/view/${token}`;
      navigator.clipboard.writeText(link).then(() => {
        alert('Share link copied to clipboard!');
      }).catch(() => {
        prompt('Copy this link:', link);
      });
    }

    // Handle share form submission
    document.getElementById('shareForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const fileId = document.getElementById('shareFileId').value;
      const email = document.getElementById('shareEmail').value;
      const canDownload = document.getElementById('canDownload').checked;
      const canView = document.getElementById('canView').checked;
      const expiresIn = document.getElementById('expiresIn').value;

      try {
        const res = await makeAuthRequest('/api/share/share', {
          method: 'POST',
          body: JSON.stringify({
            fileId,
            sharedWithEmail: email,
            permissions: { canDownload, canView },
            expiresIn: expiresIn ? parseInt(expiresIn) : null
          })
        });

        if (res && res.ok) {
          const data = await res.json();
          alert(`File shared successfully! Share URL: ${data.shareUrl}`);
          closeShareModal();
          loadMyShares(); // Reload shares
        } else {
          const data = await res.json();
          throw new Error(data.message);
        }
      } catch (err) {
        alert('Failed to share file: ' + err.message);
      }
    });

  // QR Code Functions
  async function generateQRCode(fileId) {
    const qrOptions = prompt(`Generate QR Code for file sharing:

Options (JSON format):
{
  "isPublic": true/false,
  "maxAccess": number or null,
  "expiresIn": days or null
}

Enter options (or leave empty for defaults):`);

    let options = {
      fileId,
      generateQR: true,
      isPublic: false,
      maxAccess: null,
      expiresIn: null,
      permissions: { canDownload: true, canView: true }
    };

    if (qrOptions && qrOptions.trim()) {
      try {
        const userOptions = JSON.parse(qrOptions);
        options = { ...options, ...userOptions };
      } catch (e) {
        alert('Invalid JSON format. Using default options.');
      }
    }

    try {
      showLoader('Generating QR code...');
      
      const res = await makeAuthRequest('/api/share/generate-qr', {
        method: 'POST',
        body: JSON.stringify(options)
      });

      hideLoader();

      if (res && res.ok) {
        const data = await res.json();
        
        // Open QR code display in a new window/tab
        const qrWindow = window.open('', '_blank', 'width=600,height=700');
        qrWindow.document.write(`
          <html>
            <head>
              <title>QR Code - Vaultify</title>
              <style>
                body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
                .qr-container { max-width: 400px; margin: 0 auto; }
                .qr-image { max-width: 256px; border: 2px solid #ddd; border-radius: 8px; }
                .share-url { background: #f5f5f5; padding: 10px; border-radius: 4px; word-break: break-all; margin: 10px 0; }
                .btn { background: #7c3aed; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
              </style>
            </head>
            <body>
              <div class="qr-container">
                <h2>ðŸ“± QR Code Generated</h2>
                <img src="${data.qrCode}" class="qr-image" alt="QR Code">
                <div class="share-url">${data.qrShareUrl || data.shareUrl}</div>
                <button class="btn" onclick="navigator.clipboard.writeText('${data.qrShareUrl || data.shareUrl}').then(() => alert('URL copied!'))">Copy URL</button>
                <button class="btn" onclick="window.close()">Close</button>
              </div>
            </body>
          </html>
        `);
        
        loadMyShares(); // Reload shares to show the new QR share
      } else {
        const data = await res.json();
        throw new Error(data.message);
      }
    } catch (err) {
      hideLoader();
      alert('Failed to generate QR code: ' + err.message);
    }
  }

  async function viewQRCode(shareId) {
    try {
      showLoader('Loading QR code...');
      
      const res = await makeAuthRequest(`/api/share/qr-details/${shareId}`);
      
      hideLoader();

      if (res && res.ok) {
        const data = await res.json();
        window.open(`qr-share.html?shareId=${shareId}`, '_blank');
      } else {
        const errorData = await res.json();
        throw new Error(errorData.message);
      }
    } catch (err) {
      hideLoader();
      alert('Failed to load QR code: ' + err.message);
    }
  }

function showLoader(message) {
  const overlay = document.getElementById('loadingOverlay');
  const loadingMessage = document.getElementById('loadingMessage');
  loadingMessage.textContent = message || 'Loading...';
  overlay.style.display = 'flex';
}

function hideLoader() {
  const overlay = document.getElementById('loadingOverlay');
  overlay.style.display = 'none';
}

function logout() {
    sessionStorage.removeItem("token");
    window.location.href = "/login.html";
  }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', () => {
      fetchDashboardData(); // Load initial overview
    });
  </script>
</body>
</html>
