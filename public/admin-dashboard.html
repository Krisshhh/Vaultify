<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - FileVault</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .admin-dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    .stat-card {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: #007bff;
    }
    .users-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .users-table th, .users-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .users-table th {
      background-color: #f2f2f2;
    }
    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab-button {
      padding: 10px 20px;
      border: none;
      background: #007bff;
      color: white;
      cursor: pointer;
      border-radius: 4px;
    }
    .tab-button.active {
      background: #0056b3;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Admin Dashboard</h1>
      <button onclick="logout()">Logout</button>
    </div>

    <div class="tab-buttons">
      <button class="tab-button active" onclick="showTab('overview')">Overview</button>
      <button class="tab-button" onclick="showTab('users')">Users</button>
      <button class="tab-button" onclick="showTab('analytics')">Analytics</button>
      <button class="tab-button" onclick="showTab('system')">System Health</button>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
      <div class="admin-dashboard" id="statsContainer">
        <!-- Stats will be loaded here -->
      </div>
    </div>

    <!-- Users Tab -->
    <div id="users" class="tab-content">
      <div>
        <input type="text" id="userSearch" placeholder="Search users..." />
        <select id="roleFilter">
          <option value="">All Roles</option>
          <option value="user">Users</option>
          <option value="admin">Admins</option>
        </select>
        <button onclick="loadUsers()">Search</button>
      </div>
      <table class="users-table">
        <thead>
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Files</th>
            <th>Shares</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersTableBody">
          <!-- Users will be loaded here -->
        </tbody>
      </table>
    </div>

    <!-- Analytics Tab -->
    <div id="analytics" class="tab-content">
      <div>
        <label>Period: </label>
        <select id="analyticsPeriod">
          <option value="7">Last 7 days</option>
          <option value="30" selected>Last 30 days</option>
          <option value="90">Last 90 days</option>
        </select>
        <button onclick="loadAnalytics()">Update</button>
      </div>
      <div id="analyticsContainer">
        <!-- Analytics charts would go here -->
        <div class="stat-card">
          <h3>User Analytics</h3>
          <div id="userAnalytics"></div>
        </div>
        <div class="stat-card">
          <h3>File Analytics</h3>
          <div id="fileAnalytics"></div>
        </div>
      </div>
    </div>

    <!-- System Health Tab -->
    <div id="system" class="tab-content">
      <div id="systemHealthContainer">
        <!-- System health metrics will be loaded here -->
      </div>
    </div>
  </div>

  <script>
    let currentTab = 'overview';

    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(tabName).classList.add('active');
      document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
      
      currentTab = tabName;
      
      // Load data for the tab
      switch(tabName) {
        case 'overview':
          loadDashboardStats();
          break;
        case 'users':
          loadUsers();
          break;
        case 'analytics':
          loadAnalytics();
          break;
        case 'system':
          loadSystemHealth();
          break;
      }
    }

    async function makeAuthRequest(url, options = {}) {
      const token = sessionStorage.getItem('token');
      if (!token) {
        alert('Please login first');
        window.location.href = '/login.html';
        return null;
      }

      const response = await fetch(url, {
        ...options,
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
          ...options.headers
        }
      });

      if (response.status === 401 || response.status === 403) {
        alert('Session expired or access denied');
        sessionStorage.removeItem('token');
        window.location.href = '/login.html';
        return null;
      }

      return response;
    }

    async function loadDashboardStats() {
      try {
        const response = await makeAuthRequest('/api/admin/dashboard/stats');
        if (!response) return;

        const data = await response.json();
        
        const statsHtml = `
          <div class="stat-card">
            <div class="stat-number">${data.overview.totalUsers}</div>
            <div>Total Users</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${data.overview.totalFiles}</div>
            <div>Total Files</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${data.overview.totalShares}</div>
            <div>Active Shares</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${data.overview.totalStorageGB} GB</div>
            <div>Storage Used</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${data.recent.newUsers}</div>
            <div>New Users (30d)</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${data.recent.newUploads}</div>
            <div>New Uploads (30d)</div>
          </div>
        `;
        
        document.getElementById('statsContainer').innerHTML = statsHtml;
      } catch (err) {
        console.error('Error loading dashboard stats:', err);
        alert('Failed to load dashboard statistics');
      }
    }

    async function loadUsers() {
      try {
        const search = document.getElementById('userSearch').value;
        const role = document.getElementById('roleFilter').value;
        
        let url = '/api/admin/users?';
        if (search) url += `search=${encodeURIComponent(search)}&`;
        if (role) url += `role=${role}&`;
        
        const response = await makeAuthRequest(url);
        if (!response) return;

        const data = await response.json();
        
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = data.users.map(user => `
          <tr>
            <td>${user.username}</td>
            <td>${user.email}</td>
            <td>${user.role}</td>
            <td>${user.fileCount}</td>
            <td>${user.shareCount}</td>
            <td>${new Date(user.createdAt).toLocaleDateString()}</td>
            <td>
              <select onchange="updateUserRole('${user._id}', this.value)">
                <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
              </select>
            </td>
          </tr>
        `).join('');
        
      } catch (err) {
        console.error('Error loading users:', err);
        alert('Failed to load users');
      }
    }

    async function updateUserRole(userId, newRole) {
      try {
        const response = await makeAuthRequest(`/api/admin/users/${userId}/role`, {
          method: 'PUT',
          body: JSON.stringify({ role: newRole })
        });
        
        if (response && response.ok) {
          alert('User role updated successfully');
          loadUsers(); // Reload the users list
        } else {
          alert('Failed to update user role');
        }
      } catch (err) {
        console.error('Error updating user role:', err);
        alert('Failed to update user role');
      }
    }

    async function loadAnalytics() {
      try {
        const period = document.getElementById('analyticsPeriod').value;
        
        const [userResponse, fileResponse] = await Promise.all([
          makeAuthRequest(`/api/admin/analytics/users?period=${period}`),
          makeAuthRequest(`/api/admin/analytics/files?period=${period}`)
        ]);
        
        if (!userResponse || !fileResponse) return;
        
        const userData = await userResponse.json();
        const fileData = await fileResponse.json();
        
        // Display user analytics
        document.getElementById('userAnalytics').innerHTML = `
          <p>Active Users: ${userData.activeUsers}</p>
          <p>User Activity Events: ${userData.userActivity.reduce((sum, event) => sum + event.count, 0)}</p>
        `;
        
        // Display file analytics
        document.getElementById('fileAnalytics').innerHTML = `
          <p>Upload Trends: ${fileData.uploadTrends.length} days with uploads</p>
          <p>File Types: ${fileData.fileTypes.length} different types</p>
          <p>Popular Files: ${fileData.popularFiles.length} files with downloads</p>
        `;
        
      } catch (err) {
        console.error('Error loading analytics:', err);
        alert('Failed to load analytics');
      }
    }

    async function loadSystemHealth() {
      try {
        const response = await makeAuthRequest('/api/admin/system/health');
        if (!response) return;

        const data = await response.json();
        
        document.getElementById('systemHealthContainer').innerHTML = `
          <div class="stat-card">
            <h3>Current Hour Activity</h3>
            <p>Logins: ${data.currentHour.logins}</p>
            <p>Uploads: ${data.currentHour.uploads}</p>
            <p>Downloads: ${data.currentHour.downloads}</p>
          </div>
          <div class="stat-card">
            <h3>System Status</h3>
            <p>Status: ${data.systemStatus}</p>
            <p>Daily Activity Events: ${data.dailyActivity.length}</p>
          </div>
        `;
        
      } catch (err) {
        console.error('Error loading system health:', err);
        alert('Failed to load system health');
      }
    }

    function logout() {
      sessionStorage.removeItem('token');
      sessionStorage.removeItem('userRole');
      window.location.href = '/login.html';
    }

    // Load initial data
    document.addEventListener('DOMContentLoaded', () => {
      const userRole = sessionStorage.getItem('userRole');
      if (userRole !== 'admin') {
        alert('Admin access required');
        window.location.href = '/login.html';
        return;
      }
      
      loadDashboardStats();
    });
  </script>
</body>
</html>
