<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Vaultify</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="dashboard-layout">
  <header class="main-header">
    <nav class="navbar">
      <div class="navbar-brand">
        <a href="/admin-dashboard.html">Vaultify Admin</a>
      </div>
      <div class="navbar-center">
        <ul class="navbar-menu">
          <li><a href="#" onclick="showTab('overview')" class="nav-active">Overview</a></li>
          <li><a href="#" onclick="showTab('users')">Users</a></li>
          <li><a href="#" onclick="showTab('analytics')">Analytics</a></li>
          <li><a href="#" onclick="showTab('system')">System</a></li>
        </ul>
      </div>
      <div class="navbar-right">
        <a href="#" onclick="logout()" class="btn btn-secondary btn-small">Logout</a>
      </div>
      <button class="navbar-toggle" aria-label="Toggle Navigation">
        <span class="toggle-icon"></span>
        <span class="toggle-icon"></span>
        <span class="toggle-icon"></span>
      </button>
    </nav>
  </header>
  <main class="container">
    <div class="header">
      <h1>Admin Dashboard</h1>
      <button onclick="logout()">Logout</button>
    </div>

    <div class="tab-buttons">
      <button class="tab-button active" onclick="showTab('overview')">Overview</button>
      <button class="tab-button" onclick="showTab('users')">Users</button>
      <button class="tab-button" onclick="showTab('analytics')">Analytics</button>
      <button class="tab-button" onclick="showTab('system')">System Health</button>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
      <div class="admin-dashboard" id="statsContainer">
        <!-- Stats will be loaded here -->
      </div>
    </div>

    <!-- Users Tab -->
    <div id="users" class="tab-content">
      <div>
        <input type="text" id="userSearch" placeholder="Search users..." />
        <select id="roleFilter">
          <option value="">All Roles</option>
          <option value="user">Users</option>
          <option value="admin">Admins</option>
        </select>
        <button onclick="loadUsers()">Search</button>
      </div>
      <table class="users-table">
        <thead>
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Files</th>
            <th>Shares</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersTableBody">
          <!-- Users will be loaded here -->
        </tbody>
      </table>
    </div>

    <!-- Analytics Tab -->
    <div id="analytics" class="tab-content">
      <div>
        <label>Period: </label>
        <select id="analyticsPeriod">
          <option value="7">Last 7 days</option>
          <option value="30" selected>Last 30 days</option>
          <option value="90">Last 90 days</option>
        </select>
        <button onclick="loadAnalytics()">Update</button>
      </div>
      <div id="analyticsContainer">
        <!-- Analytics charts would go here -->
        <div class="stat-card">
          <h3>User Analytics</h3>
          <div id="userAnalytics"></div>
        </div>
        <div class="stat-card">
          <h3>File Analytics</h3>
          <div id="fileAnalytics"></div>
        </div>
      </div>
    </div>

    <!-- System Health Tab -->
    <div id="system" class="tab-content">
      <div id="systemHealthContainer">
        <!-- System health metrics will be loaded here -->
      </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <div id="loadingMessage">Loading...</div>
      </div>
    </div>
  </main>

  <script>
    // Mobile navbar toggle
    const toggleButton = document.querySelector('.navbar-toggle');
    const navbarMenu = document.querySelector('.navbar-menu');

    if (toggleButton && navbarMenu) {
      toggleButton.addEventListener('click', () => {
        navbarMenu.classList.toggle('active');
      });

      // Close mobile menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!toggleButton.contains(e.target) && !navbarMenu.contains(e.target)) {
          navbarMenu.classList.remove('active');
        }
      });
    }
    let currentTab = 'overview';

    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(tabName).classList.add('active');
      document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
      
      currentTab = tabName;
      
      // Load data for the tab
      switch(tabName) {
        case 'overview':
          loadDashboardStats();
          break;
        case 'users':
          loadUsers();
          break;
        case 'analytics':
          loadAnalytics();
          break;
        case 'system':
          loadSystemHealth();
          break;
      }
    }

    async function makeAuthRequest(url, options = {}) {
      const token = sessionStorage.getItem('token');
      if (!token) {
        alert('Please login first');
        window.location.href = '/login.html';
        return null;
      }

      const response = await fetch(url, {
        ...options,
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
          ...options.headers
        }
      });

      if (response.status === 401 || response.status === 403) {
        alert('Session expired or access denied');
        sessionStorage.removeItem('token');
        window.location.href = '/login.html';
        return null;
      }

      return response;
    }

    async function loadDashboardStats() {
      try {
        const response = await makeAuthRequest('/api/admin/dashboard/stats');
        if (!response) return;

        const data = await response.json();
        
        const statsHtml = `
          <div class="stat-card">
            <div class="stat-number">${data.overview.totalUsers}</div>
            <div>Total Users</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${data.overview.totalFiles}</div>
            <div>Total Files</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${data.overview.totalShares}</div>
            <div>Active Shares</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${data.overview.totalStorageGB} GB</div>
            <div>Storage Used</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${data.recent.newUsers}</div>
            <div>New Users (30d)</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${data.recent.newUploads}</div>
            <div>New Uploads (30d)</div>
          </div>
        `;
        
        document.getElementById('statsContainer').innerHTML = statsHtml;
      } catch (err) {
        console.error('Error loading dashboard stats:', err);
        alert('Failed to load dashboard statistics');
      }
    }

    async function loadUsers() {
      try {
        const search = document.getElementById('userSearch').value;
        const role = document.getElementById('roleFilter').value;
        
        let url = '/api/admin/users?';
        if (search) url += `search=${encodeURIComponent(search)}&`;
        if (role) url += `role=${role}&`;
        
        const response = await makeAuthRequest(url);
        if (!response) return;

        const data = await response.json();
        
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = data.users.map(user => `
          <tr>
            <td>${user.username}</td>
            <td>${user.email}</td>
            <td>${user.role}</td>
            <td>${user.fileCount}</td>
            <td>${user.shareCount}</td>
            <td>${new Date(user.createdAt).toLocaleDateString()}</td>
            <td>
              <select onchange="updateUserRole('${user._id}', this.value)">
                <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
              </select>
            </td>
          </tr>
        `).join('');
        
      } catch (err) {
        console.error('Error loading users:', err);
        alert('Failed to load users');
      }
    }

    async function updateUserRole(userId, newRole) {
      try {
        const response = await makeAuthRequest(`/api/admin/users/${userId}/role`, {
          method: 'PUT',
          body: JSON.stringify({ role: newRole })
        });
        
        if (response && response.ok) {
          alert('User role updated successfully');
          loadUsers(); // Reload the users list
        } else {
          alert('Failed to update user role');
        }
      } catch (err) {
        console.error('Error updating user role:', err);
        alert('Failed to update user role');
      }
    }

    async function loadAnalytics() {
      try {
        showLoader('Loading analytics...');
        const period = document.getElementById('analyticsPeriod').value;
        
        const [userResponse, fileResponse] = await Promise.all([
          makeAuthRequest(`/api/admin/analytics/users?period=${period}`),
          makeAuthRequest(`/api/admin/analytics/files?period=${period}`)
        ]);
        
        hideLoader();
        
        if (!userResponse || !fileResponse) return;
        
        const userData = await userResponse.json();
        const fileData = await fileResponse.json();
        
        // Display user analytics
        const totalUserEvents = userData.userActivity.reduce((sum, event) => sum + event.count, 0);
        const userActivityBreakdown = userData.userActivity.map(activity => 
          `${activity._id}: ${activity.count}`
        ).join('<br>');
        
        document.getElementById('userAnalytics').innerHTML = `
          <p><strong>Active Users:</strong> ${userData.activeUsers}</p>
          <p><strong>Total Activity Events:</strong> ${totalUserEvents}</p>
          <p><strong>User Registration Trends:</strong> ${userData.userTrends.length} days with registrations</p>
          <div style="margin-top: 10px; font-size: 0.9em;">
            <strong>Activity Breakdown:</strong><br>
            ${userActivityBreakdown || 'No activity data'}
          </div>
          ${userData.debug ? `<div style="margin-top: 10px; font-size: 0.8em; color: #666;">
            Debug: ${userData.debug.totalAnalytics} total analytics, ${userData.debug.recentAnalytics} recent
          </div>` : ''}
        `;
        
        // Display file analytics
        const totalUploads = fileData.uploadTrends.reduce((sum, trend) => sum + trend.count, 0);
        const topFileTypes = fileData.fileTypes.slice(0, 3).map(type => 
          `${type._id}: ${type.count}`
        ).join('<br>');
        
        document.getElementById('fileAnalytics').innerHTML = `
          <p><strong>Upload Trends:</strong> ${totalUploads} uploads in ${fileData.uploadTrends.length} days</p>
          <p><strong>File Types:</strong> ${fileData.fileTypes.length} different types</p>
          <p><strong>Popular Files:</strong> ${fileData.popularFiles.length} files with downloads</p>
          <div style="margin-top: 10px; font-size: 0.9em;">
            <strong>Top File Types:</strong><br>
            ${topFileTypes || 'No file type data'}
          </div>
        `;
        
      } catch (err) {
        hideLoader();
        console.error('Error loading analytics:', err);
        alert('Failed to load analytics');
      }
    }

    async function loadSystemHealth() {
      try {
        const response = await makeAuthRequest('/api/admin/system/health');
        if (!response) return;

        const data = await response.json();
        
        document.getElementById('systemHealthContainer').innerHTML = `
          <div class="stat-card">
            <h3>Current Hour Activity</h3>
            <p>Logins: ${data.currentHour.logins}</p>
            <p>Uploads: ${data.currentHour.uploads}</p>
            <p>Downloads: ${data.currentHour.downloads}</p>
          </div>
          <div class="stat-card">
            <h3>System Status</h3>
            <p>Status: ${data.systemStatus}</p>
            <p>Daily Activity Events: ${data.dailyActivity.length}</p>
          </div>
        `;
        
      } catch (err) {
        console.error('Error loading system health:', err);
        alert('Failed to load system health');
      }
    }

    function showLoader(message) {
      const overlay = document.getElementById('loadingOverlay');
      const loadingMessage = document.getElementById('loadingMessage');
      loadingMessage.textContent = message || 'Loading...';
      overlay.style.display = 'flex';
    }

    function hideLoader() {
      const overlay = document.getElementById('loadingOverlay');
      overlay.style.display = 'none';
    }

    function logout() {
      sessionStorage.removeItem('token');
      sessionStorage.removeItem('userRole');
      window.location.href = '/login.html';
    }

    // Load initial data
    document.addEventListener('DOMContentLoaded', () => {
      const userRole = sessionStorage.getItem('userRole');
      if (userRole !== 'admin') {
        alert('Admin access required');
        window.location.href = '/login.html';
        return;
      }
      
      loadDashboardStats();
    });
  </script>
</body>
</html>
